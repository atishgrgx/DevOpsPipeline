pipeline {
    agent any

    environment {
        SONARQUBE_SERVER = 'SonarCloud'
        PORT = '3000'
        MONGO_URL = 'mongodb+srv://jukeboxuser:jukeboxuser@jukeboxdb.v158hmf.mongodb.net/JUKEBOXDB?retryWrites=true&w=majority&appName=JukeBoxDB'
        MONGO_SECRET_KEY = '12345678901234567890123456789012'
        JWT_SECRET = 'MyS3cr3tJwT_K3y!'
        SPOTIFY_CLIENT_ID = '715291451b004afdae8c8fd356e3c22e'
        SPOTIFY_CLIENT_SECRET = '6c0a6a201bdc4d6e9c05ec93238b6eab'
        SPOTIFY_REDIRECT_URI = 'http://127.0.0.1:3000/api/auth/spotify/callback'
        FRONTEND_URL = 'http://localhost:3000'
    }

    stages {
        stage('Build') {
            steps {
                echo 'ğŸ“¦ Installing dependencies...'
                bat 'cd jukebox-backend && npm install'

                echo 'ğŸ—œï¸ Creating build artifact (ZIP)...'
                bat 'cd jukebox-backend && if exist build-artifact.zip del build-artifact.zip && powershell Compress-Archive -Path * -DestinationPath build-artifact.zip'
            }
        }

        stage('Test') {
            steps {
                echo 'ğŸ§ª Running tests...'
                bat 'cd jukebox-backend && npm test || echo "No tests found or test failure â€“ continuing..."'
            }
        }

        stage('Code Quality') {
            steps {
                echo 'ğŸ“ Running SonarCloud analysis...'
                withSonarQubeEnv('SonarCloud') {
                    bat 'cd jukebox-backend && sonar-scanner -Dsonar.projectKey=atishgrgx_jukebox -Dsonar.sources=.'
                }
            }
        }

        stage('Security Scan') {
            steps {
                echo 'ğŸ›¡ï¸ Running security scan with Snyk...'
                bat 'cd jukebox-backend && npx snyk test || echo "Snyk scan failed or vulnerabilities found"'
            }
        }

        stage('Deploy to Staging') {
            steps {
                echo 'ğŸš€ Deploying to staging environment...'
                bat 'rmdir /s /q staging-folder'
                bat 'mkdir staging-folder'
                bat 'cd jukebox-backend && powershell Expand-Archive -Path build-artifact.zip -DestinationPath ../staging-folder'
                bat 'cd staging-folder && npm install && start "" /B cmd /c "npm start"'
            }
        }

        stage('Release to Production') {
            steps {
                echo 'ğŸš€ Promoting to production (simulated)...'
                bat 'git tag v1.0.0 && git push origin v1.0.0'
            }
        }

        stage('Monitoring') {
            steps {
                echo 'ğŸ“ˆ Simulating monitoring check...'
                bat 'curl -s -f http://localhost:3000/health || echo "App not responding!"'
            }
        }
    }

    post {
        always {
            echo 'ğŸ§¹ Pipeline completed.'
        }
    }
}
